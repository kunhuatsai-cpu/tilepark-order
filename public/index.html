
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tile Park Admin System - Inventory & Lot Control</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
.font-mono { font-family: 'JetBrains Mono', monospace; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { opacity: 1; }
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;
const API_URL = "https://script.google.com/macros/s/AKfycbyKP7YGKdSFYYJMEI2tH7t3u3lILjfc3XGK-xlFx0o3se2_QnnvP-vNtEGcgZXt1Xx7/exec";

// --- 安全工具集 (防崩潰核心) ---
const Utils = {
safeStr: (v) => String(v || '').trim(),
safeDate: (v) => {
const s = Utils.safeStr(v);
return s.includes('T') ? s.split('T')[0] : s;
},
parseQty: (v) => {
const num = parseFloat(Utils.safeStr(v).replace(/[^\d.]/g, ''));
return isNaN(num) ? 0 : num;
},
cleanFuzzy: (v) => Utils.safeStr(v).toLowerCase().replace(/[^a-z0-9]/g, '')
};

// --- 核心圖示定義 (確保組件不會是 undefined) ---
const IconWrap = ({ d, size = 18, className = "" }) => (
<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
{d}
</svg>
);

const UI = {
Search: (p) => <IconWrap {...p} d={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
Refresh: (p) => <IconWrap {...p} d={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
Package: (p) => <IconWrap {...p} d={<><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></>} />,
Close: (p) => <IconWrap {...p} d={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
Check: (p) => <IconWrap {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
Truck: (p) => <IconWrap {...p} d={<><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>} />,
Loader: (p) => <IconWrap {...p} d={<><path d="M21 12a9 9 0 1 1-6.219-8.56" /></>} />,
Save: (p) => <IconWrap {...p} d={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
DB: (p) => <IconWrap {...p} d={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
Trash: (p) => <IconWrap {...p} d={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
Info: (p) => <IconWrap {...p} d={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />,
File: (p) => <IconWrap {...p} d={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />
};

const StatusBadge = ({ status }) => {
let color = "bg-green-100 text-green-800 border-green-200";
if (status === '已確認庫存') color = "bg-teal-100 text-teal-800 border-teal-200";
if (status === '已排單出貨') color = "bg-blue-100 text-blue-800 border-blue-200";
return <span className={`px-2 py-1 rounded-full text-[10px] font-bold border ${color} whitespace-nowrap`}>{status || '已接收'}</span>;
};

const OrderDetailModal = ({ order, inventory, onClose, onUpdateStatus, onUpdateDetails, onDelete, isProcessing }) => {
if (!order) return null;

const [internalNote, setInternalNote] = useState(Utils.safeStr(order.internalNote));
const [factoryEta, setFactoryEta] = useState(Utils.safeStr(order.factoryEta));
const [deliveryDate, setDeliveryDate] = useState(Utils.safeDate(order.deliveryDate));
const [isSavingDetails, setIsSavingDetails] = useState(false);
const [saveSuccess, setSaveSuccess] = useState(false);

// --- 修正：定義 isStockConfirmed 和 isShipped ---
const isStockConfirmed = order.status === '已確認庫存';
const isShipped = order.status === '已排單出貨';

// --- 解析品名與數量 (優化尺寸誤判問題) ---
const [editableItems, setEditableItems] = useState(() => {
try {
const rawItems = Utils.safeStr(order.items).split('\n').filter(l => l.trim() !== "");
return rawItems.map(line => {
let s = Utils.safeStr(line).replace(/^(\d+[\.\s]+)/, ''); // 移除序號

// 改良 Regex：要求 x 前後有空格，或者是末尾的 x+數字，避免誤認尺寸
const regex = /^(.*?)\s+[xX\*\u00d7]\s*([\d\.]+)\s*([^\(\s]*)(?:\s*\((.*)\))?$/;
const match = s.match(regex);
if (match) return { name: match[1].trim(), originalQty: match[2].trim(), currentQty: match[2].trim(), unit: match[3] || '', note: match[4] || '' };

const fb = s.match(/^(.*?)([xX\*\u00d7])([\d\.]+)$/);
if (fb) return { name: fb[1].trim(), originalQty: fb[3].trim(), currentQty: fb[3].trim(), unit: '', note: '' };

return { name: s, originalQty: '1', currentQty: '1', unit: '', note: '' };
});
} catch (e) {
return [{ name: "解析錯誤，請手動確認明細", originalQty: '0', currentQty: '0', unit: '', note: '' }];
}
});

// --- 核心庫存匹配邏輯 (HTS151-2 / AO-2 優化版) ---
const getProductMatches = (orderItemName) => {
if (!Array.isArray(inventory) || inventory.length === 0) return [];
const targetFull = Utils.safeStr(orderItemName).toLowerCase();
const targetCleaned = Utils.cleanFuzzy(orderItemName);

const matches = inventory.filter(inv => {
const q = Utils.parseQty(inv.qty);
if (q <= 0) return false;

const invID = Utils.safeStr(inv.id).toLowerCase();
const cleanID = Utils.cleanFuzzy(inv.id);

// 比對策略：
// 1. 貨號 (A 欄) 完全出現在訂單品名中
// 2. 去除符號後的貨號 (hts1512) 包含在清理後的訂單文字中
return (invID && targetFull.includes(invID)) ||
(cleanID && targetCleaned.includes(cleanID));
});

const groups = matches.reduce((acc, curr) => {
const key = `${curr.id}-${curr.name}`;
if (!acc[key]) acc[key] = { id: curr.id, name: curr.name, spec: curr.spec, total: 0, lots: [] };
acc[key].total += Utils.parseQty(curr.qty);
acc[key].lots.push(curr);
return acc;
}, {});
return Object.values(groups);
};

const handleUpdateItemQty = (index, value) => {
const updated = [...editableItems];
updated[index].currentQty = value;
setEditableItems(updated);
};

const handleSave = async () => {
setIsSavingDetails(true);
try {
const itemsString = editableItems.map(i => `${i.name} x ${i.currentQty}${i.unit} ${i.note ? `(${i.note})` : ''}`).join('\n');
const success = await onUpdateDetails(order.orderId, { internalNote, factoryEta, deliveryDate, items: itemsString });
if (success) { setSaveSuccess(true); setTimeout(() => setSaveSuccess(false), 3000); }
} finally { setIsSavingDetails(false); }
};

return (
<div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in font-sans text-gray-800">
<div className="bg-white w-full max-w-5xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
<div className={`${order.orderType?.includes('保留') ? 'bg-blue-600' : 'bg-[#222]'} text-white p-4 flex justify-between items-center shrink-0`}>
<div className="flex flex-col">
<span className="text-[10px] uppercase font-bold opacity-70 tracking-widest font-sans">A06REPORT Warehouse Management</span>
<h2 className="text-xl font-bold font-mono">訂單 #{order.orderId}</h2>
</div>
<button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-all"><UI.Close size={24} /></button>
</div>

<div className="p-6 overflow-y-auto custom-scrollbar bg-gray-50 flex-1 font-sans">
{/* --- 控制項 --- */}
<div className="bg-white border rounded-xl p-5 mb-6 shadow-sm flex flex-col sm:flex-row gap-6">
<label className="flex-1 flex items-center gap-4 cursor-pointer select-none">
<div className={`w-12 h-12 rounded-xl flex items-center justify-center border-2 transition-all ${isStockConfirmed ? 'bg-teal-500 border-teal-500 shadow-lg' : 'bg-white border-gray-200'}`}>
{isStockConfirmed ? <UI.Check size={28} className="text-white" /> : <UI.DB size={24} className="text-gray-300" />}
</div>
<div className="flex flex-col">
<span className={`font-bold ${isStockConfirmed ? 'text-teal-700' : 'text-gray-700'}`}>已確認批號庫存</span>
<span className="text-xs text-gray-400">核對現場存貨與 A06REPORT</span>
</div>
<input type="checkbox" className="hidden" checked={isStockConfirmed} onChange={() => !isStockConfirmed && onUpdateStatus([order.orderId], '已確認庫存')} disabled={isProcessing || isStockConfirmed} />
</label>
<div className="hidden sm:block w-px bg-gray-100 h-14 self-center"></div>
<label className="flex-1 flex items-center gap-4 cursor-pointer select-none">
<div className={`w-12 h-12 rounded-xl flex items-center justify-center border-2 transition-all ${isShipped ? 'bg-blue-500 border-blue-500 shadow-lg' : 'bg-white border-gray-200'}`}>
{isShipped ? <UI.Check size={28} className="text-white" /> : <UI.Truck size={24} className="text-gray-300" />}
</div>
<div className="flex flex-col">
<span className={`font-bold ${isShipped ? 'text-blue-700' : 'text-gray-700'}`}>已排單出貨</span>
<span className="text-xs text-gray-400">安排物流派送並結案</span>
</div>
<input type="checkbox" className="hidden" checked={isShipped} onChange={() => !isShipped && onUpdateStatus([order.orderId], '已排單出貨')} disabled={isProcessing || isShipped} />
</label>
</div>

{/* --- 商品清單 --- */}
<section className="mb-8 font-sans">
<div className="flex justify-between items-center mb-4 px-1">
<h3 className="text-xs font-black uppercase tracking-widest text-orange-600 font-bold font-sans">訂單商品與庫存批號對照</h3>
<div className="flex items-center gap-2 text-[10px] text-gray-400">
<div className={`w-2.5 h-2.5 rounded-full ${inventory.length > 0 ? 'bg-green-500 shadow-sm' : 'bg-red-500 animate-pulse'}`}></div>
A06REPORT 已同步: {inventory.length} 筆
</div>
</div>

<div className="space-y-6">
{editableItems.map((item, idx) => {
const matches = getProductMatches(item.name);
const currentNeed = Utils.parseQty(item.currentQty);
return (
<div key={idx} className="bg-white border rounded-xl overflow-hidden shadow-sm hover:border-orange-300 transition-all font-sans">
<div className="p-4 bg-gray-50 border-b flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 text-gray-800">
<div className="flex-1 min-w-0 font-sans">
<div className="text-[15px] font-black text-gray-900 leading-tight mb-1">{item.name}</div>
<div className="flex items-center gap-2 text-[10px] text-gray-400 font-medium">
<UI.Info size={12}/> 訂單原文: {item.name}
</div>
</div>
<div className="flex items-center gap-6 bg-white p-2 rounded-lg border border-gray-200 shadow-inner font-sans shrink-0">
<div className="flex flex-col items-center px-4 border-r border-gray-100">
<span className="text-[9px] font-bold text-gray-400 uppercase mb-0.5">原始下單量</span>
<span className="font-mono text-base font-black text-gray-800">{item.originalQty} <span className="text-[10px] font-normal">{item.unit}</span></span>
</div>
<div className="flex flex-col items-center px-4">
<span className="text-[9px] font-bold text-orange-600 uppercase mb-0.5 font-bold">客服調整數</span>
<div className="flex items-center gap-1.5 font-sans">
<input type="number" value={item.currentQty} onChange={(e) => handleUpdateItemQty(idx, e.target.value)} className="w-16 p-1 border border-orange-300 rounded text-base font-black text-center outline-none bg-orange-50 focus:ring-2 focus:ring-orange-200 text-orange-700" />
<span className="text-[11px] font-bold text-gray-500">{item.unit}</span>
</div>
</div>
</div>
</div>
<div className="p-4 font-sans">
{matches.length > 0 ? (
<div className="grid grid-cols-1 gap-4 font-sans">
{matches.map((group, gIdx) => (
<div key={gIdx} className="border border-teal-100 bg-teal-50/10 rounded-lg p-3 font-sans">
<div className="flex justify-between items-center mb-3 pb-2 border-b border-teal-100">
<div className="flex flex-col">
<div className="flex items-center gap-2 mb-1">
<span className="font-mono text-[11px] font-black bg-teal-600 text-white px-1.5 py-0.5 rounded shadow-sm">{group.id}</span>
<span className="text-[13px] font-bold text-gray-700 truncate max-w-[200px]">{group.name}</span>
</div>
<div className="text-[10px] text-gray-400 font-medium">規格: {group.spec || '標規'}</div>
</div>
<div className="text-right">
<span className="text-[10px] text-gray-400 block uppercase font-bold tracking-tighter">總剩餘庫存</span>
<span className={`text-xl font-black ${group.total < currentNeed ? 'text-red-500 underline' : 'text-teal-600'}`}>{group.total}</span>
</div>
</div>
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 font-sans">
{group.lots.map((lot, lIdx) => (
<div key={lIdx} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex flex-col hover:border-teal-400 transition-colors group font-sans">
<span className="text-[9px] text-gray-400 font-bold uppercase mb-1 group-hover:text-teal-500 tracking-wider">Batch 批號</span>
<span className="font-mono text-sm font-black text-[#c25e00] break-all leading-tight mb-2 font-sans">{lot.lot || "無標註"}</span>
<div className="mt-auto pt-2 border-t border-gray-50 flex justify-between items-end">
<span className="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">剩餘數量</span>
<span className="font-black text-[15px] text-teal-600 font-mono leading-none">{lot.qty}</span>
</div>
</div>
))}
</div>
</div>
))}
</div>
) : (
<div className="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300 font-sans">
<UI.Search size={44} className="mx-auto text-gray-300 mb-3"/>
<p className="text-sm text-gray-400 font-black uppercase tracking-widest font-sans">No Match in A06REPORT</p>
<p className="text-[11px] text-gray-400 mt-2 font-sans px-4">無法在數據分頁中自動匹配到： <span className="font-bold font-mono text-gray-600">"{item.name}"</span></p>
<p className="text-[9px] text-gray-300 mt-2 italic px-8 font-sans">提示：系統會嘗試比對試算表 A 欄貨號。請檢查貨號是否包含在品名中。</p>
</div>
)}
</div>
</div>
);
})}
</div>
</section>

{/* --- 操作區 --- */}
<div className="pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 font-sans font-bold">
<button onClick={() => confirm(`確定刪除訂單 #${order.orderId}？此操作不可撤回。`) && onDelete([order.orderId]) && onClose()} className="text-red-400 hover:text-red-600 text-sm font-bold flex items-center gap-1.5 px-4 py-2 hover:bg-red-50 rounded-lg transition-colors font-sans"><UI.Trash size={16}/> 刪除單據</button>
<button onClick={handleSave} disabled={isSavingDetails} className={`w-full sm:w-auto px-10 py-3.5 rounded-xl text-sm font-black text-white transition-all shadow-lg flex items-center justify-center gap-3 active:scale-95 ${saveSuccess ? 'bg-green-600 shadow-green-100' : 'bg-[#c25e00] hover:bg-[#a04d00] shadow-orange-100'} font-sans font-bold`}>
{isSavingDetails ? <UI.Loader size={20} className="animate-spin" /> : saveSuccess ? <UI.Check size={20} /> : <UI.Save size={20} />}
{isSavingDetails ? '正在同步數據...' : saveSuccess ? '變更已成功同步' : '儲存數量與所有變更'}
</button>
</div>
</div>
</div>
</div>
);
};

function App() {
const [isLoggedIn, setIsLoggedIn] = useState(false);
const [password, setPassword] = useState("");
const [orders, setOrders] = useState([]);
const [inventory, setInventory] = useState([]);
const [filteredOrders, setFilteredOrders] = useState([]);
const [searchTerm, setSearchTerm] = useState("");
const [selectedOrder, setSelectedOrder] = useState(null);
const [selectedIds, setSelectedIds] = useState(new Set());
const [loading, setLoading] = useState(false);
const [apiError, setApiError] = useState(null);
const [lastUpdated, setLastUpdated] = useState("");

const fetchAllData = useCallback(async () => {
setLoading(true); setApiError(null);
try {
const res = await fetch(`${API_URL}?t=${Date.now()}`, { redirect: 'follow' });
const result = await res.json();
if (result.error) throw new Error(result.error);
setOrders(result.orders || []);
setInventory(result.inventory || []);
setLastUpdated(new Date().toLocaleTimeString());
} catch (error) {
console.error("Fetch Error:", error);
setApiError("無法讀取雲端數據，請檢查 Google Script 部署與權限。");
} finally {
setLoading(false);
}
}, []);

useEffect(() => { if (isLoggedIn) fetchAllData(); }, [isLoggedIn, fetchAllData]);

useEffect(() => {
let res = orders;
if (searchTerm) {
const t = searchTerm.toLowerCase();
res = res.filter(o => Utils.safeStr(o.company).toLowerCase().includes(t) || Utils.safeStr(o.orderId).toLowerCase().includes(t));
}
setFilteredOrders(res);
}, [searchTerm, orders]);

const sendCommand = async (p) => {
try {
await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: new URLSearchParams({ payload: JSON.stringify(p) }) });
return true;
} catch (e) { return false; }
};

const handleUpdateDetails = async (id, details) => {
const ok = await sendCommand({ action: 'updateDetails', orderId: id, ...details });
if (ok) {
setOrders(prev => prev.map(o => o.orderId === id ? { ...o, ...details } : o));
return true;
}
return false;
};

const handleStatusUpdate = async (ids, status) => {
const targetIds = ids || Array.from(selectedIds);
if (await sendCommand({ action: 'updateStatus', status, ids: targetIds })) {
setOrders(prev => prev.map(o => targetIds.includes(o.orderId) ? { ...o, status } : o));
setSelectedIds(new Set());
if (selectedOrder && targetIds.includes(selectedOrder.orderId)) setSelectedOrder(p => p ? ({ ...p, status }) : null);
setTimeout(fetchAllData, 1000);
}
};

if (!isLoggedIn) {
return (
<div className="min-h-screen bg-[#111] flex items-center justify-center p-4">
<div className="w-full max-w-sm bg-white/5 p-10 rounded-[2rem] border border-white/10 shadow-2xl text-center font-sans font-bold">
<h1 className="text-3xl font-black text-white tracking-[0.2em] mb-10 font-sans">TILE PARK</h1>
<form onSubmit={(e) => { e.preventDefault(); if(password==='8888') setIsLoggedIn(true); }} className="space-y-6">
<input type="password" placeholder="PASSWORD" className="w-full px-6 py-4 bg-black/40 border border-white/10 rounded-2xl text-white text-center tracking-[1em] focus:border-orange-500 outline-none transition-all font-mono" value={password} onChange={e=>setPassword(e.target.value)} autoFocus />
<button type="submit" className="w-full bg-[#c25e00] text-white py-4 rounded-2xl font-black tracking-widest hover:bg-orange-600 transition-all uppercase font-bold shadow-lg">Login</button>
</form>
</div>
</div>
);
}

return (
<div className="h-screen w-full bg-gray-100 flex flex-col md:flex-row overflow-hidden text-gray-800 font-sans font-bold">
<aside className="bg-[#1a1a1a] text-white md:w-64 flex flex-col p-6 border-b md:border-b-0 border-white/5 shrink-0 font-sans">
<div className="mb-10 font-black text-xl tracking-tighter">TILE PARK <span className="block text-[10px] text-orange-500 font-mono tracking-widest font-normal opacity-80 uppercase">Warehouse Portal</span></div>
<nav className="space-y-2">
<button className="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-[#c25e00] text-white font-bold text-sm shadow-lg shadow-orange-900/40"><UI.File size={18} /> 訂單管理中心</button>
</nav>
<div className="mt-auto text-[10px] text-gray-500 font-mono text-center opacity-40">Last Sync: {lastUpdated}</div>
</aside>

<main className="flex-1 flex flex-col min-h-0 relative font-sans">
<header className="bg-white border-b p-5 flex flex-col gap-4 shadow-sm z-10 font-sans">
<div className="flex flex-col sm:flex-row justify-between items-center gap-4 font-bold">
<h2 className="text-xl font-black text-gray-800 tracking-tight font-sans">訂單後台與庫存對應系統</h2>
<div className="flex w-full sm:w-auto gap-2 font-sans font-bold">
<div className="relative flex-1 sm:w-80 font-sans">
<UI.Search className="absolute left-3 top-3 text-gray-400" size={16} />
<input type="text" placeholder="搜尋客戶名稱或訂單單號..." className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-orange-500 transition-all font-medium text-gray-800 font-sans" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
</div>
<button onClick={fetchAllData} className={`p-2.5 bg-white border border-gray-200 rounded-xl transition-all active:scale-90 ${loading ? 'animate-spin text-orange-500' : 'text-gray-500 hover:bg-gray-50'} font-sans font-bold`}><UI.Refresh size={20}/></button>
</div>
</div>
</header>

<div className="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar pb-32 font-sans">
{apiError && (
<div className="mb-6 p-5 bg-red-50 border border-red-200 rounded-2xl text-red-600 text-sm font-bold flex items-center gap-3 animate-fade-in font-sans font-bold">
<UI.Info size={20}/><span className="flex-1 font-sans">{apiError}</span>
<button onClick={fetchAllData} className="px-4 py-2 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700 transition-colors shadow-sm font-sans font-bold">重新整理數據</button>
</div>
)}

<div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden font-sans">
<div className="overflow-x-auto">
<table className="w-full text-sm text-left text-gray-700 font-sans">
<thead className="bg-gray-50 text-[10px] font-black uppercase text-gray-400 border-b tracking-widest font-sans font-bold">
<tr>
<th className="p-4 w-12 text-center font-sans font-bold"><input type="checkbox" className="rounded" onChange={e => setSelectedIds(e.target.checked ? new Set(filteredOrders.map(o=>o.orderId)) : new Set())} checked={selectedIds.size > 0 && selectedIds.size === filteredOrders.length} /></th>
<th className="p-4 font-sans font-bold">單號</th><th className="p-4 text-center font-sans font-bold">狀態</th><th className="p-4 font-sans font-bold">客戶名稱</th><th className="p-4 font-sans font-bold text-center">預計出貨</th><th className="p-4 text-right pr-6 font-sans font-bold">操作</th>
</tr>
</thead>
<tbody className="divide-y divide-gray-100 font-medium font-sans font-bold">
{filteredOrders.length === 0 && !loading ? (
<tr><td colSpan="6" 箱className="p-10 text-center text-gray-400 italic font-normal font-sans font-bold">目前無訂單數據。</td></tr>
) : (
filteredOrders.map(o => (
<tr key={o.orderId} className={`hover:bg-orange-50/30 transition-colors cursor-pointer ${selectedIds.has(o.orderId) ? 'bg-orange-50/50' : ''} font-sans`} onClick={()=>setSelectedOrder(o)}>
<td className="p-4 text-center font-sans font-bold" onClick={e=>e.stopPropagation()}><input type="checkbox" className="rounded border-gray-300 text-orange-600 focus:ring-orange-500 font-sans font-bold" checked={selectedIds.has(o.orderId)} onChange={()=>{ const n = new Set(selectedIds); n.has(o.orderId) ? n.delete(o.orderId) : n.add(o.orderId); setSelectedIds(n); }} /></td>
<td className="p-4 font-bold font-mono text-gray-800 font-sans font-bold">{o.orderId}</td>
<td className="p-4 text-center font-sans"><StatusBadge status={o.status} /></td>
<td className="p-4 font-bold font-sans text-gray-800 font-sans">{o.company}</td>
<td className="p-4 text-gray-500 font-mono text-xs font-sans text-center">{Utils.safeDate(o.deliveryDate) || '未排程'}</td>
<td className="p-4 text-right pr-6 font-sans font-bold"><button className="text-[10px] font-black text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border hover:bg-orange-100 hover:text-orange-600 transition-all font-bold font-sans">Detail</button></td>
</tr>
))
)}
</tbody>
</table>
</div>
</div>
</div>

{selectedIds.size > 0 && (
<div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/95 border border-gray-200 shadow-2xl rounded-2xl px-6 py-4 flex items-center gap-6 animate-slide-up z-40 font-bold font-sans font-bold">
<span className="text-sm font-black text-gray-600 border-r border-gray-200 pr-6 whitespace-nowrap font-sans">已選 <span className="text-orange-600 font-mono font-bold font-bold">{selectedIds.size}</span> 筆</span>
<div className="flex gap-3">
<button onClick={()=>handleStatusUpdate(null, '已確認庫存')} className="flex items-center gap-2 text-xs font-black text-teal-700 bg-teal-50 px-4 py-2 rounded-xl border border-teal-100 shadow-sm hover:bg-teal-100 transition-all font-sans font-bold"><UI.Check size={16}/> 確認庫存</button>
<button onClick={()=>handleStatusUpdate(null, '已排單出貨')} className="flex items-center gap-2 text-xs font-black text-blue-700 bg-blue-50 px-4 py-2 rounded-xl border border-blue-100 shadow-sm hover:bg-blue-100 transition-all font-sans font-bold"><UI.Truck size={16}/> 排單出貨</button>
</div>
</div>
)}
</main>

{selectedOrder && <OrderDetailModal order={selectedOrder} inventory={inventory} onClose={()=>setSelectedOrder(null)} onUpdateStatus={handleStatusUpdate} onUpdateDetails={handleUpdateDetails} onDelete={ids => handleStatusUpdate(ids, 'delete')} isProcessing={loading} />}
</div>
);
}
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
